<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Backlog</title>
    <style type="text/css">
        #contenido{
            border:1px solid black;
            padding: 1rem;
            display:flex;
            margin-left:auto;
            margin-right:auto;
            justify-content: space-around;
        }
        #backlog, #sprints, #sprint_backlog{
            border:1px solid black;
            margin:1rem;
        }
        #backlog h1, #sprints h1, #sprint_backlog h1, #sprint_backlog h3{
            text-align: center;
        }
        .historia{
            margin:1rem;
            background-color:yellow;
            padding: 1rem;
        }
        .sprint{
            margin:1rem;
            background:lightblue;
            padding: 1rem;
            overflow:hidden;
        }
        .valor_historia{
            background-color:gray;
        }
        .btn_detalles_historia, .btn_detalles_sprint{
            float:right;
        }
        #comp_info_historia{
            position:absolute;
            margin:auto;
            top:0;
            left:0;
            bottom:0;
            right:0;
            border:1px solid black;
            background-color: rgba(0,0,0,0.5);
            padding: 3em;
        }
        #comp_info_historia div{
            position:absolute;
            padding: 3em;
            margin:auto;
            top:30%;
            left:30%;
            right:30%;
            bottom:30%;
            background-color:azure;
        }
        #icono_cargando_comp_info_historia{
            width:20px;
        }
    </style>
</head>
<body>
    <div id="contenido">
        <div id="backlog">
            <h1>Backlog</h1>
            <button id="btn_nueva_historia">Nueva historia</button>
        </div>
        <div id="sprints">
            <h1>Sprints</h1>
            <div class="sprint">
                <h1>Sprint 1</h1>
                <button class="btn_detalles_sprint">Mostrar detalles</button>
            </div>
        </div>
        <div id="sprint_backlog">
            <h1>Sprint backlog</h1>
            <h3>(Sprint 1)</h3>
            <div class="historia" id="hu#1">
                <ul>
                    <li class="etiqueta_historia">HU#1</li>
                    <li class="nombre_historia">Nombre de la historia de ejemplo</li>
                </ul>
                <span class="valor_historia" title="Valor de negocio">100</span>
                <button class="btn_detalles_historia">Mostrar detalles</button>
            </div>            
        </div>
    </div>

    <div id="comp_info_historia">
        <div>
            <h1>Nueva historia</h1>
            <ul>
                <li><label for="input_nombre_historia">Nombre</label><input type="text" id="input_nombre_historia"/></li>
                <li><label for="input_etiqueta_historia">Etiqueta</label><input type="text" id="input_etiqueta_historia" placeholder="Opciona"/></li>
                <li><textarea id="input_descripcion_historia" placeholder="Descripción de la historia"></textarea></li>
                <li><label for="input_valor_historia">Valor de negocio</label><input type="number" id="input_valor_historia"/></li>
                <li><button id="btn_aceptar_info_historia">Aceptar</button><button id="btn_cancelar_info_historia">Cancelar</button></li>
            </ul>
            <img id="icono_cargando_comp_info_historia" src="recursos/loading.gif"/>
        </div>
    </div>
    
    <script type="text/javascript">
        
// -------------------------------------------------------
        
        var HistoriaHelper = {
            id: null,
            init: function(id, nombre, descripcion, valor){
                this.id = id;
                this.nombre = nombre;
                this.descripcion = descripcion;
                this.valor = valor;
            },
            fromObjeto: function(historia){
                this.id = historia.id;
                this.nombre = historia.nombre;
                this.descripcion = historia.descripcion;
                this.valor = historia.valor;
                return this;
            },
            /*getIdFromDOMObject: function(domObject){
                return domObject.getElementsByTagName("li")[0].value;
            },*/
            getHistoriaDOM: function(){
                var historia = "";
                if (this.id){
                    historia = " <ul>" +
                               "    <li class='etiqueta_historia'>" + this.id + "</li>" +
                               "    <li class='nombre_historia'>" + this.nombre + "</li>" +
                               " </ul>" +
                               " <span class='valor_historia' title='Valor de negocio'>" + this.valor + "</span>" +
                               " <button class='btn_detalles_historia' onclick='HistoriaView.solicitar.mostrarDetalles(this.parentNode);'>Mostrar detalles</button><button class='btn_borrar_historia' onclick='HistoriaView.solicitar.borrarHistoria(this.parentNode);'>Borrar historia</button>";
                    var historiaDOM = document.createElement("div");
                    historiaDOM.setAttribute("class","historia");
                    historiaDOM.setAttribute("draggable","true");
                    historiaDOM.setAttribute("id",this.id);
                    historiaDOM.innerHTML = historia;
                    return historiaDOM;
                } else {
                    return null;
                }
            },
            fromDOM: function(historiaDOM){
                this.id = historiaDOM.querySelector(".etiqueta_historia").textContent;
                this.nombre = historiaDOM.querySelector(".nombre_historia").textContent;
                this.valor = parseInt(historiaDOM.querySelector(".valor_historia").textContent);
            },
            igual: function(historia){
                if ((this.id == historia.id) && 
                    (this.nombre == historia.nombre) &&
                    (this.nombre == historia.nombre) &&
                    (this.valor == this.valor)){
                    return true;
                } else {
                    return false;
                }
            }
        };
        
// -------------------------------------------------------
        
        var DBBacklogQuery = {
            setViewModelCallback:function(callback){
                this.callback = callback;
            },
            solicitudes: {
                // Todos los métodos en este objeto simulan una consulta AJAX con el servidor. Para ello
                // provocan un retraso en la ejecución de la notificación.
                getAllHistorias: function(){
                    if (DBBacklogQuery.callback){
                        setTimeout(DBBacklogQuery.notificaciones.resultadoAllHistorias,1000);
                    }
                },
                insertHistoria: function(historia){
                    if (DBBacklogQuery.callback){
                        setTimeout(function(){DBBacklogQuery.notificaciones.insercion(JSON.stringify(historia))},1000);
                    }
                },
                borrarHistoriaById: function(idHistoria){
                    if (DBBacklogQuery.callback){
                        setTimeout(function(){
                                        DBBacklogQuery.notificaciones.borrado(JSON.stringify(BacklogViewModel.historias[idHistoria]));
                                    },1000);
                    }
                },
                actualizarHistoria: function(historia){
                    if (DBBacklogQuery.callback){
                        setTimeout(function(){
                                        DBBacklogQuery.notificaciones.actualizacion(JSON.stringify(historia));
                                    },1000);
                    }
                }  
            },
            notificaciones: {
                resultadoAllHistorias: function(){
                    // SIMULACIÓN DE RESPUESTA AJAX //
                    DBBacklogQuery.callback(DBBacklogQuery.historiasEjemploJSON());
                },
                insercion: function(historiaJSON){
                    DBBacklogQuery.callback(historiaJSON);  
                },
                borrado: function(historiaJSON){
                    DBBacklogQuery.callback(historiaJSON);
                },
                actualizacion: function(historiaJSON){
                    DBBacklogQuery.callback(historiaJSON);
                }
            },
            historiasEjemploJSON: function(){
                return JSON.stringify({
                                        "HU#A": {id: "HU#A",
                                                nombre: "Historia A",
                                                descripcion: "Descripción de la historia A",
                                                valor: 200
                                            },
                                        "HU#B": {id:"HU#B",
                                                nombre: "Historia B",
                                                descripcion: "Descripción de la historia B",
                                                valor: 200
                                            },
                                        "HU#C": {id:"HU#C",
                                                nombre: "Historia C",
                                                descripcion: "Descripción de la historia C",
                                                valor: 200}
                                    });}
        };
        

// -------------------------------------------------------        
  
        
        var BacklogViewModel = {
            historias: {},
            setViewCallback: function(callback){
                this.callback = callback;
            },
            ejecutar: function(com,args){
                this.acciones[com](args);
            },
            acciones: {
                solicitarHistorias: function(){
                    DBBacklogQuery.setViewModelCallback(BacklogViewModel.callbacks.notificarAllHistorias);
                    DBBacklogQuery.solicitudes.getAllHistorias();
                },
                validarNuevaHistoria: function(nuevaHistoria){
                    if (BacklogViewModel.historias[nuevaHistoria.id] == undefined){
                        DBBacklogQuery.setViewModelCallback(BacklogViewModel.callbacks.notificarValidacionNuevaHistoria);
                        DBBacklogQuery.solicitudes.insertHistoria(nuevaHistoria);
                    } else {
                        BacklogViewModel.callback(null);
                    }
                },
                borrarHistoriaById: function(id){
                    if (BacklogViewModel.historias[id]){
                        DBBacklogQuery.setViewModelCallback(BacklogViewModel.callbacks.notificarHistoriaBorrada);
                        DBBacklogQuery.solicitudes.borrarHistoriaById(id);
                    } else {
                        alert("No se ha podido borrar la historia");
                    }
                },
                solicitarHistoria: function(id){
                    if (BacklogViewModel.historias[id]){
                        // No hacemos consulta a DBBacklogQuery. Lanzamos el callback directamente.
                        BacklogViewModel.callback(BacklogViewModel.historias[id]);
                    }
                },
                actualizarHistoria: function(historia){
                    var historiaSinActualizar = BacklogViewModel.historias[historia.id];
                    if (historiaSinActualizar){
                        var historiaSinActualizarHelper = Object.create(HistoriaHelper);
                        historiaSinActualizarHelper.fromObjeto(historiaSinActualizar);
                        if (historiaSinActualizarHelper.igual(historia)){
                            InfoHistoriaView.interface.ocultar();
                            alert("La historia no se ha modificado");
                            console.log(document.getElementById("icono_cargando_comp_info_historia").style.visibility);
                        } else {
                            DBBacklogQuery.setViewModelCallback(BacklogViewModel.callbacks.notificarHistoriaActualizada);
                            DBBacklogQuery.solicitudes.actualizarHistoria(historia);
                        
                        }    
                    } else {
                        InfoHistoriaView.interface.ocultar();
                        alert("La historia no se ha modificado");
                        console.log(document.getElementById("icono_cargando_comp_info_historia").style.visibility);
                    }
                }
            },
            callbacks:{
                notificarAllHistorias: function(historiasJSON){
                    var historias = JSON.parse(historiasJSON);
                    BacklogViewModel.historias = historias;
                    BacklogViewModel.callback(historias);
                },
                notificarValidacionNuevaHistoria: function(nuevaHistoriaJSON){
                    var nuevaHistoria = JSON.parse(nuevaHistoriaJSON);
                    if (Object.keys(nuevaHistoria).length > 0){
                        BacklogViewModel.historias[nuevaHistoria.id] = nuevaHistoria;
                        BacklogViewModel.callback(nuevaHistoria);
                    } else {
                        BacklogViewModel.callback(null);    
                    }
                            
                },
                notificarHistoriaBorrada: function(historiaBorradaJSON){
                    var historiaBorrada = JSON.parse(historiaBorradaJSON);
                    if (Object.keys(historiaBorrada).length > 0){
                        delete BacklogViewModel.historias[historiaBorrada.id];
                        BacklogViewModel.callback(historiaBorrada.id);    
                    } else {
                        alert("No se ha podido borrar la historia");
                    }
                },
                notificarHistoriaActualizada: function(historiaActualizadaJSON){
                    var historiaActualizada = JSON.parse(historiaActualizadaJSON);
                    BacklogViewModel.historias[historiaActualizada.id] = historiaActualizada;
                    BacklogViewModel.callback(historiaActualizada);
                }
            }
        }

// -------------------------------------------------------        
        
        var InfoHistoriaView = {
            init: function(){
                this.interface.ocultar();
                var botonCancelarInfoHistoria = document.getElementById("btn_cancelar_info_historia");
                botonCancelarInfoHistoria.addEventListener("click",InfoHistoriaView.interface.ocultar);
                // El comportamiento del botón "btn_aceptar_info_historia" se asigna en el método InfoHistoriaView.interface.mostrar,
                // ya que varía dependiendo de la funcionalidad (insertar/actualizar).
            },
            interface: {
                mostrar: function(comportamiento){
                    document.getElementById("comp_info_historia").style.visibility = "visible";
                    InfoHistoriaView.interface.ocultarIconoCargando();
                    if (comportamiento == InfoHistoriaView.comportamiento.FUNCIONALIDAD_INSERTAR){
                        InfoHistoriaView.interface.limpiarCampos();        
                        InfoHistoriaView.interface.setCampoIdModificable();
                        InfoHistoriaView.interface.setTitulo("Insertar nueva historia");
                        InfoHistoriaView.comportamiento.setModoInsertar();
                    } else if (comportamiento == InfoHistoriaView.comportamiento.FUNCIONALIDAD_ACTUALIZAR){
                        InfoHistoriaView.interface.setCampoIdNoModificable();
                        InfoHistoriaView.interface.setTitulo("Actualizar historia");
                        InfoHistoriaView.comportamiento.setModoActualizar();
                    }
                },                
                ocultar: function(){
                    document.getElementById("comp_info_historia").style.visibility = "hidden";
                    InfoHistoriaView.interface.ocultarIconoCargando();
                },
                setHistoria: function(historia){
                    document.getElementById("input_nombre_historia").value = historia.nombre;
                    document.getElementById("input_etiqueta_historia").value = historia.id;
                    document.getElementById("input_descripcion_historia").value = historia.descripcion;
                    document.getElementById("input_valor_historia").value = historia.valor;
                },
                getHistoria: function(){
                    var historia = new Object();
                    historia.nombre = document.getElementById("input_nombre_historia").value;
                    historia.id = document.getElementById("input_etiqueta_historia").value.replace(/\s*/g,'');
                    historia.descripcion = document.getElementById("input_descripcion_historia").value;
                    historia.valor = document.getElementById("input_valor_historia").value;
                    return historia;
                },
                setCampoIdNoModificable: function(){
                    var campoId = document.getElementById("input_etiqueta_historia");
                    campoId.readOnly = true;
                    campoId.style.backgroundColor = "lightgray";
                },
                setCampoIdModificable: function(){
                    var campoId = document.getElementById("input_etiqueta_historia");
                    campoId.readOnly = false;
                    campoId.style.backgroundColor = "white";
                },
                limpiarCampos: function(){
                    document.getElementById("input_nombre_historia").value = "";
                    document.getElementById("input_etiqueta_historia").value = "";
                    document.getElementById("input_descripcion_historia").value = "";
                    document.getElementById("input_valor_historia").value = "";
                },
                setTitulo: function(textoTitulo){
                    var titulo = document.getElementById("comp_info_historia").getElementsByTagName("h1")[0];
                    console.log(titulo);
                    titulo.textContent = textoTitulo;
                },
                mostrarIconoCargando: function(){
                    var icono = document.getElementById("icono_cargando_comp_info_historia");
                    icono.style.visibility = "visible";
                },
                ocultarIconoCargando: function(){
                    document.getElementById("icono_cargando_comp_info_historia").style.visibility = "hidden";        
                }
            },
            comportamiento: {
                FUNCIONALIDAD_INSERTAR: 0,
                FUNCIONALIDAD_ACTUALIZAR: 1,
                setModoInsertar: function(){
                    var botonInfoHistoria = document.getElementById("btn_aceptar_info_historia");
                    botonInfoHistoria.removeEventListener("click",InfoHistoriaView.solicitar.actualizarHistoria);
                    botonInfoHistoria.addEventListener("click",InfoHistoriaView.solicitar.insertarHistoria);                    
                },
                setModoActualizar: function(){
                    var botonInfoHistoria = document.getElementById("btn_aceptar_info_historia");
                    botonInfoHistoria.removeEventListener("click",InfoHistoriaView.solicitar.insertarHistoria);
                    botonInfoHistoria.addEventListener("click",InfoHistoriaView.solicitar.actualizarHistoria);
                },
                cancelar: function(){
                    InfoHistoriaView.interface.ocultar();
                }
            },
            solicitar: {
                // El callback para la solicitud "insertarHistoria" está en BacklogViewModel.
                insertarHistoria: function(){ 
                    var historia = InfoHistoriaView.interface.getHistoria();
                    BacklogViewModel.setViewCallback(BacklogView.callbacks.insertarHistoria);
                    BacklogViewModel.ejecutar("validarNuevaHistoria",historia);
                    InfoHistoriaView.interface.mostrarIconoCargando();
                },
                actualizarHistoria: function(){
                    var historia = InfoHistoriaView.interface.getHistoria();
                    BacklogViewModel.setViewCallback(BacklogView.callbacks.actualizarHistoria);
                    BacklogViewModel.ejecutar("actualizarHistoria",historia);
                    InfoHistoriaView.interface.mostrarIconoCargando();
                }
            },
            callbacks: {
                cargarHistoria: function(historia){
                    InfoHistoriaView.interface.mostrar(InfoHistoriaView.comportamiento.FUNCIONALIDAD_ACTUALIZAR);
                    InfoHistoriaView.interface.setHistoria(historia);
                }
            }
        }
        
// -------------------------------------------------------
        
        var HistoriaView = {
            solicitar: {
                borrarHistoria: function(historiaDOM){
                    var historiaHelper = Object.create(HistoriaHelper);
                    historiaHelper.fromDOM(historiaDOM);
                    BacklogViewModel.setViewCallback(HistoriaView.callbacks.borrarHistoria);
                    BacklogViewModel.ejecutar("borrarHistoriaById",historiaHelper.id);
                },
                // Esta solicitud utiliza un callback de la vista InfoHistoriaView.
                mostrarDetalles: function(historiaDOM){
                    var historiaHelper = Object.create(HistoriaHelper);
                    historiaHelper.fromDOM(historiaDOM);
                    BacklogViewModel.setViewCallback(InfoHistoriaView.callbacks.cargarHistoria);
                    BacklogViewModel.ejecutar("solicitarHistoria",historiaHelper.id);
                }
            },
            callbacks: {
                borrarHistoria: function(idHistoria){
                    var historiaDOM = document.getElementById(idHistoria);
                    historiaDOM.parentNode.removeChild(historiaDOM);
                },
                mostrarDetallesHistoria: function(historia){
                    InfoHistoriaView.solicitar.cargarHistoria(historia.id);
                }              
            }
        }
        
        
// -------------------------------------------------------
        
        var BacklogView = {
            init: function(){
                this.solicitar.actualizarHistorias();
                var botonNuevaHistoria = document.getElementById("btn_nueva_historia");
                botonNuevaHistoria.addEventListener("click", function(){
                                                                InfoHistoriaView.interface.mostrar(InfoHistoriaView.comportamiento.FUNCIONALIDAD_INSERTAR)
                                                             });
            },
            interface: {
                drawHistoria: function(historiaHelper){
                    if (historiaHelper.id){
                        var backlog = document.getElementById("backlog");
                        backlog.appendChild(historiaHelper.getHistoriaDOM());
                    }   
                },
                replaceHistoria: function(historiaHelper){
                    var historiaAntiguaDOM = document.getElementById(historiaHelper.id);
                    historiaAntiguaDOM.parentNode.insertBefore(historiaHelper.getHistoriaDOM(),historiaAntiguaDOM);
                    historiaAntiguaDOM.parentNode.removeChild(historiaAntiguaDOM);
                }
            },
            solicitar: {
                actualizarHistorias: function(){
                    BacklogViewModel.setViewCallback(BacklogView.callbacks.actualizarHistorias);
                    BacklogViewModel.ejecutar("solicitarHistorias");
                }
            },
            callbacks: {
                actualizarHistorias: function(historias){
                        for (var id in historias){
                            var historiaHelper = Object.create(HistoriaHelper);
                            historiaHelper.fromObjeto(historias[id]);
                            BacklogView.interface.drawHistoria(historiaHelper);
                        }
                },
                insertarHistoria: function(historia){
                    if (historia){
                        var historiaHelper = Object.create(HistoriaHelper);
                        historiaHelper.fromObjeto(historia);
                        BacklogView.interface.drawHistoria(historiaHelper);
                        InfoHistoriaView.interface.ocultar();
                    } else {
                        alert("La historia ya existe");
                    }
                },
                actualizarHistoria: function(historia){
                    if (historia){
                        var historiaHelper = Object.create(HistoriaHelper);
                        historiaHelper.fromObjeto(historia);
                        BacklogView.interface.replaceHistoria(historiaHelper);
                        InfoHistoriaView.interface.ocultar();
                    } else {
                        alert("No se ha podido actualizar la historia");
                    }
                }
            }
            
        };
        
        InfoHistoriaView.init();
        BacklogView.init();
    </script>
        
</body>
</html>